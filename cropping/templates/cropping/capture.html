<!DOCTYPE html>
<html>
<head>
    <title>Webcam Image Cropper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
</head>
<body>
    <div class="container">
        <div class="section">
            <h1>Webcam Image Cropper</h1>
            <img id="video" src="{% url 'detectme' %}" width="480" height="360" />
            <br>
            <button id="capture-btn">Capture</button>
            <br>
        </div>
        <div class="section">
            <button id="save-btn">Save</button>
            <br>
            <!--<img id="image" src="" alt="Cropped Image">-->
            <input type="text" id="image-name" name="image-name" placeholder="Enter image name">
            <br>
            <input type="text" id="object-name" name="object-name" placeholder="Enter object name">
            <br>
            <canvas id="canvas" width="480" height="360"></canvas>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const capBtn = document.getElementById('capture-btn');

        let cropper;

        capBtn.addEventListener('click', () => {
            const video = document.getElementById('video');
            context.drawImage(video, 0, 0, 480, 360);

            cropper = new Cropper(canvas, {
                aspectRatio: NaN,
                viewMode: 1,
                dragMode: 'crop',
                movable: false,
                scalable: false,
                zoomable: false,
                cropBoxResizable: true,
                cropBoxMovable: true,
                autoCropArea: false,
                minCropBoxWidth: 100,
                minCropBoxHeight: 100,
                ready() {
                    cropper.setCropBoxData({
                        width: 200,
                        height: 200,
                    });
                },
                crop: function(event) {
                    console.log(event.detail)
                }
            });
            // Save the cropped image to the img element
            // document.getElementById('image').src = cropper.getCroppedCanvas().toDataURL();
        });

        // Save the cropped image to the server
        document.getElementById('save-btn').addEventListener('click', () => {
            console.log("실행되나")
            //const dataUrl = document.getElementById('image').src;
            const imageName = document.getElementById('image-name').value;
            cropper.getCroppedCanvas().toBlob((blob) => {
                const fd = new FormData();
                fd.append('name', imageName);
                fd.append('file', blob, 'my-image.png')

                $.ajax({
                    type: "POST",
                    enctype: 'multipart/form-data',
                    data: fd,

                    success: function() {
                        alert('Image saved successfully!');
                        window.location.reload();
                    },
                    error: function() {
                        alert('Failed to save image!');
                        window.location.reload();
                    },

                    cache: false,
                    contentType: false,
                    processData: false,

                });
            });

        });
        // Save the detected object
        document.getElementById('object-name').addEventListener('change', () => {
            const objectName = document.getElementById('object-name').value;
            const data = {
                objectName: objectName,
            };
            $.ajax({
                type: "POST",
                url: "/detectme/", // replace this with the appropriate URL in your Django project
                data: JSON.stringify(data),
                contentType: "application/json",
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", $('input[name="csrfmiddlewaretoken"]').val());
                },
                dataType: "json",
                success: function(response) {
                    alert('Object detected successfully!');
                    window.location.reload();
                },
                error: function() {
                    alert('Failed to detect object!');
                    window.location.reload();
                },
            });
        });

        function detectObjectInCroppedArea(objectName) {
            if (!cropper) return;
            const cropBoxData = cropper.getCropBoxData();
            const detectionData = {
                objectName: objectName,
                x: cropBoxData.left,
                y: cropBoxData.top,
                width: cropBoxData.width,
                height: cropBoxData.height,
            };
            $.ajax({
                type: "POST",
                url: "/detectme/object_detection/", // replace this with the appropriate URL in your Django project
                data: JSON.stringify(detectionData),
                contentType: "application/json",
                dataType: "json",
                success: function(response) {
                    if (response.result) {
                        console.log("Object detected in cropped area");
                    } else {
                        console.log("Object not detected in cropped area");
                    }
                    setTimeout(() => detectObjectInCroppedArea(objectName), 1000); // Check every 1 second
                },
                error: function() {
                    console.error("Failed to detect object in cropped area");
                    setTimeout(() => detectObjectInCroppedArea(objectName), 1000); // Check every 1 second
                },
            });
        }

        // Call the new function inside the change event listener
        document.getElementById('object-name').addEventListener('change', () => {
            const objectName = document.getElementById('object-name').value;
            detectObjectInCroppedArea(objectName);
        });
    </script>
</body>
</html>

